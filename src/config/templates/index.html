{% extends "base.html" %}

{% block title %}Portfolio{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-3">
            <h5>Industry</h5>
            <input type="text" id="industry-search" class="form-control mb-3" placeholder="Search industry">
            <form id="industry-filters">
                {% for industry, count in results.facets.industries.items %}
                    <div class="form-check">
                        <input class="form-check-input industry-filter" type="checkbox" value="{{ industry }}" id="{{ industry|slugify }}"
                            {% if industry in selected_industries %}checked{% endif %}>
                        <label class="form-check-label" for="{{ industry|slugify }}">
                            {{ industry }} ({{ count }})
                        </label>
                    </div>
                {% endfor %}
            </form>
            <h5 class="mt-4">Technology</h5>
            <input type="text" id="technology-search" class="form-control mb-3" placeholder="Search technology">
            <form id="technology-filters">
                {% for technology, count in results.facets.technologies.items %}
                    <div class="form-check">
                        <input class="form-check-input technology-filter" type="checkbox" value="{{ technology }}" id="{{ technology|slugify }}"
                            {% if technology in selected_technologies %}checked{% endif %}>
                        <label class="form-check-label" for="{{ technology|slugify }}">
                            {{ technology }} ({{ count }})
                        </label>
                    </div>
                {% endfor %}
            </form>
        </div>

        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <button class="btn btn-primary">Private</button>
                    <button class="btn btn-secondary">Public</button>
                    <button class="btn btn-secondary">My sets</button>
                </div>
                <div>
                    <button class="btn btn-success">Add new project</button>
                    <button class="btn btn-success">Upload .csv</button>
                    <button class="btn btn-success">Add new set</button>
                </div>
            </div>

            <div class="search-bar mb-3">
                <input type="text" id="project-search" class="form-control" placeholder="Search">
            </div>

            <div id="project-list">
                {% for project in results.data %}
                    <div class="project-item mb-3 p-3 border rounded">
                        <h5 class="mb-1">{{ project.title }}</h5>
                        <p><strong>Industries:</strong> {{ project.industries|join:', ' }}</p>
                        <p><strong>Description:</strong>{{ project.description }}</p>
                        <p><strong>Technologies:</strong> {{ project.technologies|join:', ' }}</p>
                        {% if project.url %}
                            <p><strong>URL:</strong> <a href="{{ project.url }}" target="_blank">{{ project.url }}</a></p>
                        {% endif %}
                        <div class="d-flex justify-content-end">
                            <a href="#" class="btn btn-link">Edit</a>
                            <a href="#" class="btn btn-link text-danger">Delete</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const debounce = (func, delay) => {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const fetchProjects = () => {
            const searchQuery = document.getElementById('project-search').value.trim();
            const industries = Array.from(document.querySelectorAll('.industry-filter:checked'))
                                    .map(el => el.value)
                                    .filter(value => value); // Remove empty strings
            const technologies = Array.from(document.querySelectorAll('.technology-filter:checked'))
                                    .map(el => el.value)
                                    .filter(value => value); // Remove empty strings
        
            const urlParams = new URLSearchParams();
        
            if (searchQuery) {
                urlParams.append('q', searchQuery);
            }
        
            industries.forEach(ind => urlParams.append('industry', ind));
            technologies.forEach(tech => urlParams.append('technology', tech));
        
            fetch(`?${urlParams.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    
                    // Update the project list
                    const newProjectList = doc.getElementById('project-list').innerHTML;
                    document.getElementById('project-list').innerHTML = newProjectList;
        
                    // Update the industry facets
                    const newIndustryFilters = doc.getElementById('industry-filters').innerHTML;
                    document.getElementById('industry-filters').innerHTML = newIndustryFilters;
        
                    // Update the technology facets
                    const newTechnologyFilters = doc.getElementById('technology-filters').innerHTML;
                    document.getElementById('technology-filters').innerHTML = newTechnologyFilters;
        
                    // Rebind the event listeners after updating the filters
                    document.querySelectorAll('.industry-filter').forEach(el => {
                        el.addEventListener('change', fetchProjects);
                    });
        
                    document.querySelectorAll('.technology-filter').forEach(el => {
                        el.addEventListener('change', fetchProjects);
                    });
                })
                .catch(error => {
                    console.error('Error fetching projects:', error);
                });
        };

        const debouncedFetch = debounce(fetchProjects, 300);

        document.getElementById('project-search').addEventListener('input', debouncedFetch);

        document.querySelectorAll('.industry-filter').forEach(el => {
            el.addEventListener('change', fetchProjects);
        });

        document.querySelectorAll('.technology-filter').forEach(el => {
            el.addEventListener('change', fetchProjects);
        });

        document.getElementById('industry-search').addEventListener('input', debouncedFetch);
        document.getElementById('technology-search').addEventListener('input', debouncedFetch);
    });
</script>
{% endblock %}